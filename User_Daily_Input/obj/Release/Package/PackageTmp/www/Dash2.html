<!DOCTYPE html>
<html>
<head>
    <title>Region Category Percentage Stacked Bar Graph</title>
    <link rel="stylesheet" type="text/css" href="../semantic/dist/semantic.min.css">

    <link href="../css/jquery-ui.css" rel="stylesheet" />
    <link href="../css/jquery-ui.theme.css" rel="stylesheet" />

    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link href="../jquery-ui/MonthPicker.css" rel="stylesheet" />

    <script src="../scripts/jquery-3.6.0.js"></script>
    <script type="text/javascript" src="../semantic/dist/semantic.min.js"></script>
    <script src="../jquery-ui/jquery-ui.js"></script>


    <script src="../jquery-ui/MonthPicker.js"></script>
    <script src="../Manday_CDN/highcharts.js"></script>

    <script src="../Manday_CDN/exporting.js"></script>


    <script src="../Manday_CDN/accessibility.js"></script>

    <script src="../Manday_CDN/offline-exporting.js"></script>

    <script src="../Manday_CDN/export-data.js"></script>



    <link href="../Manday_CDN/jquery.dataTables.min.css" rel="stylesheet" />


    <link href="../Manday_CDN/buttons.dataTables.min.css" rel="stylesheet" />


    <script src="../Manday_CDN/jquery.dataTables.min.js"></script>


    <script src="../Manday_CDN/dataTables.buttons.min.js"></script>
    <script src="../Manday_CDN/jszip.min.js"></script>

    <script src="../Manday_CDN/buttons.html5.min.js"></script>


    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css">
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

    <style>
        .buttons-field {
            position: relative; /* Change to relative positioning */
            top: 0.2in; /* Move the buttons 5 inches down */
        }

        .verybigmodal {
            max-width: 96%;
        }

        .excel-button {
            background-color: #007bff;
            color: #fff;
            border: none;
        }
    </style>
</head>
<body>

    <div class="ui column grid">
        <div class="column">
            <div class="ui stacked aligned segment">
                <h2>APACHE GROUP MANDAY MONTHLY / WEEKLY GRAPH</h2>
                <br />
                <div class="ui medium form" id="">
                    <div class="six fields">
                        <div class="three wide field">
                            <label for="chart_type">Chart Type</label>
                            <select id="chart_type" class="form-control">
                                <option value="byregion">By Region</option>
                                <option value="bydepartment">By Department</option>
                                <!--<option value="bymonth">By month</option>-->

                            </select>
                        </div>
                        <div class="three wide field">
                            <label>Region</label>
                            <select id="region" input" name="skills" class="form-control">
                            </select>
                        </div>
                        <div class="three wide field" id="department_field">
                            <label>Department</label>
                            <select id="department" multiple input" class="ui fluid dropdown">
                                <option value="">Select Department</option>

                            </select>
                        </div>

                        <div class="three wide field">
                            <label for="Category">Category</label>
                            <select id="category" class="form-control">
                                <option value="" selected>Select Category</option>
                                <option value="ALL">ALL</option>
                                <option value="项目Project">项目Project</option>
                                <option value="运维-需求Maintenance-Req.">运维-需求Maintenance-Req.</option>
                                <option value="运维-日常Maintenance-Daily">运维-日常Maintenance-Daily</option>
                                <option value="行政管理Administration">行政管理Administration</option>
                                <option value="培训学习Training/Study">培训学习 Training/Study</option>
                                <option value="休假Leave">休假 Leave</option>
                                <option value="空闲Idle">空闲 Idle</option>

                            </select>
                        </div>
                        <div class="three wide field">
                            <label for="date_type"> Type</label>
                            <select id="date_type" class="form-control">
                                <option value="" selected>Select type</option>
                                <option value="byweek">By Week</option>
                                <option value="bymonth">By Month</option>


                            </select>
                        </div>
                        <div class="three wide field " id="strt">
                            <label>Start Month</label>
                            <input type="text" id="s_date" class="form-control date-picker" autocomplete="off">

                        </div>
                        <div class="three wide field " id="enddt">
                            <label>End Month</label>
                            <input type="text" id="e_date" class="form-control date-picker2" autocomplete="off">

                        </div>
                        <div class="three wide field" id="wkfrm">
                            <label> Start week</label>
                            <input type="text" id="weekPicker" autocomplete="off">

                        </div>
                        <div class="three wide field" id="wkto">
                            <label> End week</label>
                            <input type="text" id="weekPicker2" autocomplete="off">

                        </div>



                        <div class="two wide field buttons-field">
                            <div class="field right float-end">
                                <button class="ui green button" id="search" type="submit">Search</button>
                                <!--<button class="ui grey button" id="clear" type="reset">Clear</button>-->
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="container" style="width: 1200px; height: 800px; margin: 0 auto;"></div>

    <div id="excelModal" class="ui modal">

        <div class="header">
            MANDAY REPORT
        </div>
        <div class="content">
            <form id="editEmployeeForm">
                <div>
                    <table id="M_dataTable" class="ui olive celled table">

                        <thead>
                            <tr>
                                <!-- Table header rows -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
        <div class="actions">
           
            <div class="ui cancel button">Close</div>
          
        </div>
    </div>

    <input type="hidden" id="userid" />


   

</body>
</html>
<script type="text/javascript">
   // var apiURL = 'http://localhost:53943/api/apcnote/';
       var apiURL = 'http://10.3.0.70:9001/api/apcnote/';
    //var apiURL = 'http://10.3.0.208:9001/api/apcnote/';
    var user_account = '';

    var requestData = '';
    var jsonData;
    var qsParm = new Array();
    function qs() {

        var query = window.location.search.substring(1);
        var parms = query.split('&');
        for (var i = 0; i < parms.length; i++) {
            var pos = parms[i].indexOf('=');
            if (pos > 0) {
                var key = parms[i].substring(0, pos);
                var val = parms[i].substring(pos + 1);
                qsParm[key] = val;
            }
        }
        if (parms.length > 0) {
            $("#userid").val(atob(qsParm["userid"]));
            return true;
        } else {
            window.location.href = 'index.html';
            return false;
        }
    }


    function Get_company() {
        
        user_account = $('#userid').val();
        var User1 = {
            Account: user_account
        };

        $.post(apiURL + 'GetCompanyByRight', User1, function (response) {


            $('#region').append($('<option>', {
                value: '',
                text: 'Select Company'
            }));


            var arrdata = JSON.parse(response[0]);

            var content = '';

            if (arrdata.length > 2) {
                var all = '<option value="ALL">ALL</option>';
                $('#region').append(all);
            }
            if (arrdata.length > 0) {
                for (j = 0; j < arrdata.length; j++) {
                    content += '<option value="' + arrdata[j].REGION + '">' + arrdata[j].REGION + '</option>';
                }
                $('#region').append(content);
            }


        }, 'json').fail(function (jqxhr, settings, ex) {
            $(".dimmer").hide();
            alert("error: " + ex);
        });
    }
    $(document).ready(function () {
        qs();
        $('#excelModal').modal('hide');
        Get_company();
        $('#wkfrm').hide();
        $('#wkto').hide();
        $('#strt').hide();
        $('#enddt').hide();
        // $('#department_field').hide();
        //  $("department_field").hide();
        $('#region').change(function () {


            selectedRegion = $(this).val();


            if (selectedRegion == '' || selectedRegion == null) {
                alert('Please select Region');
            }
            else if (selectedRegion == 'ALL') {
                $('#department').empty();
                $('#department').dropdown('clear');

                $('#department').append($('<option>', {
                    value: '',
                    text: 'Select Department'
                }));
                $('#department').append($('<option>', {
                    value: 'ALL',
                    text: 'ALL'
                }));


            } else {

                user_account = $('#userid').val();
                var dept = {
                    Assigned_region: selectedRegion,
                    Account: user_account
                };

                $.post(apiURL + 'GetDepartmentsByRight', dept, function (response) {



                    $('#department').empty();
                    $('#department').append($('<option>', {
                        value: '',
                        text: 'Select Department'
                    }));

                    //$.each(response[0], function (index, region) {
                    //    $('#region').append($('<option>', {
                    //        value: region,
                    //        text: region
                    //    }));
                    //});
                    var arrdata = JSON.parse(response[0]);


                    var content = '';
                    if (arrdata.length > 0) {


                        for (j = 0; j < arrdata.length; j++) {

                            content = content + '<option value="' + arrdata[j].DEPARTMENT + '">' + arrdata[j].DEPARTMENT + '</option>';

                        }

                        $('#department').append(content);


                    }

                }, 'json').fail(function (jqxhr, settings, ex) {
                    $(".dimmer").hide();
                    alert("error: " + ex);
                });
                $('#department').dropdown('clear');
            }


         



        });

        $('#chart_type').change(function () {
            var selectedValue = $(this).val();
            if (selectedValue === 'byregion') {
                $('#department_field').hide();
            } else if (selectedValue === 'bydepartment') {
                $('#department_field').show();
            }
        });
        $('#date_type').change(function () {
            
            var selectedValue = $(this).val();
            if (selectedValue == 'byweek')  {
                $('#strt').hide();
                $('#enddt').hide();
                $('#wkfrm').show();
                $('#wkto').show();

            } else if(selectedValue == 'bymonth') {
                $('#wkfrm').hide();
                $('#wkto').hide();
                $('#strt').show();
                $('#enddt').show();
            }
        });
        // Initially hide the department field on page load
        $('#department_field').hide();
        $('#department').dropdown({

            onChange: function (selectedValues, selectedText, $selectedItems) {

                // Update the content of the selectedOptions element
                if (Array.isArray(selectedText)) {
                    // Update the content of the selectedOptions element
                    $('#selectedOptions').text(selectedText.join(', '));
                } else {
                    // If selectedText is not an array, it means only one option is selected
                    $('#selectedOptions').text(selectedText);
                }
            }
        });
       /* $("#s_date, #e_date").datepicker({
            dateFormat: 'yy-mm',
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true,
            onClose: function (dateText, inst) {
                var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
                var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                $(this).datepicker('setDate', new Date(year, month, 1));
            }
        });*/
        //$("#s_date, #e_date").datepicker({
        //    dateFormat: 'yy-mm',
        //    changeMonth: true,
        //    changeYear: true,
        //   // showButtonPanel: true,
        //    onClose: function (dateText, inst) {
        //        var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
        //        var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
        //        $(this).datepicker('setDate', new Date(year, month, 1));
        //    },
        //    beforeShow: function (input, inst) {
        //        inst.dpDiv.addClass('month_year_datepicker');
        //        if ((datestr = $(this).val()).length > 0) {
        //            year = datestr.substring(0, 4);
        //            month = datestr.substring(5);
        //            $(this).datepicker('option', 'defaultDate', new Date(year, month - 1, 1));
        //            $(this).datepicker('setDate', new Date(year, month - 1, 1));
        //        }
        //    }
        //});


        $('#s_date, #e_date').monthpicker({ changeYear: false, dateFormat: 'yy-mm' });



        $("#weekPicker").datepicker({
            showWeek: true,
            firstDay: 1,
            onClose: function (dateText, inst) {
                var date = $(this).datepicker('getDate');
                var weekNumber = $.datepicker.iso8601Week(date);
                $(this).val(weekNumber + ' / ' + date.getFullYear());
            }
        });
        $("#weekPicker2").datepicker({
            showWeek: true,
            firstDay: 1,
            onClose: function (dateText, inst) {
                var date = $(this).datepicker('getDate');
                var weekNumber = $.datepicker.iso8601Week(date);
                $(this).val(weekNumber + ' / ' + date.getFullYear());
            }
        });

      

    });

    function reshapeRegWeekData(data) {

        const categories = [
            '项目Project',
            '运维-需求Maintenance-Req.',
            '运维-日常Maintenance-Daily',
            '行政管理Administration',
            '培训学习 Training/Study',
            '休假 Leave',
            '空闲 Idle'
        ];
        const reshapedData = [];

        data.forEach(item => {
            const region = item.Region;
            const week = item.week_no; // Add department
            const fromDate = item.fromdate.substring(0, 10);
            const toDate = item.todate.substring(0, 10);
            const employeeCount = item.EmployeeCount;
            const baseCount = item.BaseCount;

            const key = region + '_' + week; // Generate key combining region and department

            if (!reshapedData[key]) {
                reshapedData[key] = {
                    REGION: region,
                    WEEK: week, // Add department
                    EmployeeCount: employeeCount,
                    BaseCount: baseCount,
                    FromDate: fromDate,
                    ToDate: toDate
                };
                // Initialize all columns with a default value of 0
                categories.forEach(category => {
                    const categoryKey = category.replace('.', ''); // Remove special characters
                    reshapedData[key][categoryKey + '_LT_H'] = 0;
                    reshapedData[key][categoryKey + '_Percentage'] = 0;
                });
            }

            const category = item.Category.replace('.', ''); // Remove periods
            //const categoryKey = category.replace(/[^a-zA-Z0-9]/g, ''); // Remove special characters
            reshapedData[key][category + '_LT_H'] = item.LT_H;
            reshapedData[key][category + '_Percentage'] = item.Percentage;
        });

        // Convert the reshapedData object into an array
        const reshapedArray = Object.values(reshapedData);
        return reshapedArray;
    }

    function generateRegWeekColumns(data) {

        const columns = [
            { data: 'REGION', title: 'REGION' },
            { data: 'EmployeeCount', title: 'EmployeeCount' },
            { data: 'BaseCount', title: 'BaseCount' },
            { data: 'WEEK', title: 'Week No' },
            { data: '项目Project_LT_H', title: '项目Project LT_H' },
            { data: '运维-需求Maintenance-Req_LT_H', title: '运维-需求Maintenance-Req. LT_H' },
            { data: '运维-日常Maintenance-Daily_LT_H', title: '运维-日常Maintenance-Daily LT_H' },
            { data: '行政管理Administration_LT_H', title: '行政管理Administration LT_H' },
            { data: '培训学习 Training/Study_LT_H', title: '培训学习Training/Study LT_H' },
            { data: '休假 Leave_LT_H', title: '休假 Leave LT_H' },

            { data: '空闲 Idle_LT_H', title: '空闲 Idle LT_H' },

        ];


        const sumColumn = {
            title: 'SUM (LT_H)',
            render: function (data, type, row) {
                let sum = 0;
                Object.keys(row).forEach(key => {
                    if (key.endsWith('_LT_H')) {

                        sum += parseFloat(row[key] || 0);
                    }
                });

                return sum.toFixed(2);
            }
        };
        columns.push(sumColumn);

        columns.push({ data: '项目Project_Percentage', title: '项目Project %' });
        columns.push({ data: '运维-需求Maintenance-Req_Percentage', title: '运维-需求Maintenance-Req. %' });
        columns.push({ data: '运维-日常Maintenance-Daily_Percentage', title: '运维-日常Maintenance-Daily %' });
        columns.push({ data: '行政管理Administration_Percentage', title: '行政管理Administration %' });
        columns.push({ data: '培训学习 Training/Study_Percentage', title: '休假 Leave %' });
        columns.push({ data: '休假 Leave_Percentage', title: '培训学习 Training/Study %' });
        columns.push({ data: '空闲 Idle_Percentage', title: '空闲 Idle %' });

        const sumPercent = {
            title: 'SUM (%)',
            render: function (data, type, row) {
                let sum = 0;
                Object.keys(row).forEach(key => {
                    if (key.endsWith('_Percentage')) {
                        sum += parseFloat(row[key] || 0);
                    }
                });
                return sum.toFixed(2);
            }
        };
        columns.push(sumPercent);

        columns.push({ data: 'FromDate', title: 'From Date' });
        columns.push({ data: 'ToDate', title: 'To Date' });


        return columns;
    }

    function reshapeRegMonthData(data) {

        const categories = [
            '项目Project',
            '运维-需求Maintenance-Req.',
            '运维-日常Maintenance-Daily',
            '行政管理Administration',
            '培训学习 Training/Study',
            '休假 Leave',
            '空闲 Idle'
        ];
        const reshapedData = [];

        data.forEach(item => {
            const region = item.Region;
            const mnth = item.month_name; // Add department
            const fromDate = item.fromdate.substring(0, 10);
            const toDate = item.todate.substring(0, 10);
            const employeeCount = item.EmployeeCount;
            const baseCount = item.BaseCount;

            const key = region + '_' + mnth; // Generate key combining region and department

            if (!reshapedData[key]) {
                reshapedData[key] = {
                    REGION: region,
                    MONTH: mnth, // Add department
                    EmployeeCount: employeeCount,
                    BaseCount: baseCount,
                    FromDate: fromDate,
                    ToDate: toDate
                };
                // Initialize all columns with a default value of 0
                categories.forEach(category => {
                    const categoryKey = category.replace('.', ''); // Remove special characters
                    reshapedData[key][categoryKey + '_LT_H'] = 0;
                    reshapedData[key][categoryKey + '_Percentage'] = 0;
                });
            }

            const category = item.Category.replace('.', ''); // Remove periods
            //const categoryKey = category.replace(/[^a-zA-Z0-9]/g, ''); // Remove special characters
            reshapedData[key][category + '_LT_H'] = item.LT_H;
            reshapedData[key][category + '_Percentage'] = item.Percentage;
        });

        // Convert the reshapedData object into an array
        const reshapedArray = Object.values(reshapedData);
        return reshapedArray;
    }

    function generateRegMonthColumns(data) {
        
        const columns = [
            { data: 'REGION', title: 'REGION' },
            { data: 'EmployeeCount', title: 'EmployeeCount' },
            { data: 'BaseCount', title: 'BaseCount' },
            { data: 'MONTH', title: 'Month Name' },
            { data: '项目Project_LT_H', title: '项目Project LT_H' },
            { data: '运维-需求Maintenance-Req_LT_H', title: '运维-需求Maintenance-Req. LT_H' },
            { data: '运维-日常Maintenance-Daily_LT_H', title: '运维-日常Maintenance-Daily LT_H' },
            { data: '行政管理Administration_LT_H', title: '行政管理Administration LT_H' },
            { data: '培训学习 Training/Study_LT_H', title: '培训学习Training/Study LT_H' },
            { data: '休假 Leave_LT_H', title: '休假 Leave LT_H' },

            { data: '空闲 Idle_LT_H', title: '空闲 Idle LT_H' },

        ];


        const sumColumn = {
            title: 'SUM (LT_H)',
            render: function (data, type, row) {
                let sum = 0;
                Object.keys(row).forEach(key => {
                    if (key.endsWith('_LT_H')) {

                        sum += parseFloat(row[key] || 0);
                    }
                });

                return sum.toFixed(2);
            }
        };
        columns.push(sumColumn);

        columns.push({ data: '项目Project_Percentage', title: '项目Project %' });
        columns.push({ data: '运维-需求Maintenance-Req_Percentage', title: '运维-需求Maintenance-Req. %' });
        columns.push({ data: '运维-日常Maintenance-Daily_Percentage', title: '运维-日常Maintenance-Daily %' });
        columns.push({ data: '行政管理Administration_Percentage', title: '行政管理Administration %' });
        columns.push({ data: '培训学习 Training/Study_Percentage', title: '休假 Leave %' });
        columns.push({ data: '休假 Leave_Percentage', title: '培训学习 Training/Study %' });
        columns.push({ data: '空闲 Idle_Percentage', title: '空闲 Idle %' });

        const sumPercent = {
            title: 'SUM (%)',
            render: function (data, type, row) {
                let sum = 0;
                Object.keys(row).forEach(key => {
                    if (key.endsWith('_Percentage')) {
                        sum += parseFloat(row[key] || 0);
                    }
                });
                return sum.toFixed(2);
            }
        };
        columns.push(sumPercent);

        columns.push({ data: 'FromDate', title: 'From Date' });
        columns.push({ data: 'ToDate', title: 'To Date' });


        return columns;
    }


    function generateDeptWeekColumns(data) {

        const columns = [
            { data: 'REGION', title: 'REGION' },
            { data: 'DEPARTMENT', title: 'DEPARTMENT' },
            { data: 'WEEK', title: 'Week No' },
            { data: 'EmployeeCount', title: 'EmployeeCount' },
            { data: 'BaseCount', title: 'BaseCount' },
            { data: '项目Project_LT_H', title: '项目Project LT_H' },
            { data: '运维-需求Maintenance-Req_LT_H', title: '运维-需求Maintenance-Req. LT_H' },
            { data: '运维-日常Maintenance-Daily_LT_H', title: '运维-日常Maintenance-Daily LT_H' },
            { data: '行政管理Administration_LT_H', title: '行政管理Administration LT_H' },
            { data: '培训学习 Training/Study_LT_H', title: '培训学习Training/Study LT_H' },
            { data: '休假 Leave_LT_H', title: '休假 Leave LT_H' },

            { data: '空闲 Idle_LT_H', title: '空闲 Idle LT_H' },
        ];

        /* const categories = { };
                 const categories2 = { };
         data.forEach(item => {
             const category = item.Category.replace('.', ''); // Remove periods
                 const originalCategory = item.Category;
                 if (!categories[category]) {
    
                     categories[category] = true;
                 columns.push({data: category + '_LT_H', title: originalCategory + ' (LT_H)' });
             }
         });*/

        // Add SUM (LT_H) column
        /* const sumColumn = {
                     title: 'SUM (LT_H)',
                 render: function (data, type, row) {
                     let sum = 0;
                 Object.keys(categories).forEach(category => {
                     sum += parseInt(row[category + '_LT_H'] || 0);
                 });
                 return sum;
             }
         };*/
        const sumColumn = {
            title: 'SUM (LT_H)',
            render: function (data, type, row) {
                let sum = 0;
                Object.keys(row).forEach(key => {
                    if (key.endsWith('_LT_H')) {
                        sum += parseFloat(row[key] || 0);
                    }
                });
                return sum.toFixed(2);
            }
        };
        columns.push(sumColumn);

        // Add Percentage columns
        /* data.forEach(item => {
    
             const category = item.Category.replace('.', ''); // Remove periods
                 const originalCategory = item.Category;
                 if (!categories2[category]) {
                     categories2[category] = true;
    
                 columns.push({data: category + '_Percentage', title: originalCategory + '%' });
             }
         });*/
        columns.push({ data: '项目Project_Percentage', title: '项目Project %' });
        columns.push({ data: '运维-需求Maintenance-Req_Percentage', title: '运维-需求Maintenance-Req. %' });
        columns.push({ data: '运维-日常Maintenance-Daily_Percentage', title: '运维-日常Maintenance-Daily %' });
        columns.push({ data: '行政管理Administration_Percentage', title: '行政管理Administration %' });
        columns.push({ data: '培训学习 Training/Study_Percentage', title: '休假 Leave %' });
        columns.push({ data: '休假 Leave_Percentage', title: '培训学习 Training/Study %' });
        columns.push({ data: '空闲 Idle_Percentage', title: '空闲 Idle %' });
        /* const sumPercent = {
                     title: 'SUM (%)',
                 render: function (data, type, row) {
                     let sum = 0;
                 Object.keys(categories).forEach(category => {
                     sum += parseInt(row[category + '_Percentage'] || 0);
                 });
                 return sum;
             }
         };*/
        const sumPercent = {
            title: 'SUM (%)',
            render: function (data, type, row) {
                let sum = 0;
                Object.keys(row).forEach(key => {
                    if (key.endsWith('_Percentage')) {
                        sum += parseFloat(row[key] || 0);
                    }
                });
                return sum.toFixed(2);
            }
        };
        columns.push(sumPercent);
        columns.push({ data: 'FromDate', title: 'From Date' });
        columns.push({ data: 'ToDate', title: 'To Date' });

        return columns;
    }

    function reshapeDeptWeekData(data) {

        const categories = [
            '项目Project',
            '运维-需求Maintenance-Req.',
            '运维-日常Maintenance-Daily',
            '行政管理Administration',
            '培训学习 Training/Study',
            '休假 Leave',
            '空闲 Idle'
        ];
        const reshapedData = {};

        data.forEach(item => {
            const region = item.Region;
            const department = item.Department; // Add department
            const week = item.week_no;
            const fromDate = item.fromdate.substring(0, 10);
            const toDate = item.todate.substring(0, 10);
            const employeeCount = item.EmployeeCount;
            const baseCount = item.BaseCount;

            const key = region + '_' + department + '_' + week; // Generate key combining region, department, and week

            if (!reshapedData[key]) {
                reshapedData[key] = {
                    REGION: region,
                    DEPARTMENT: department, // Add department
                    WEEK: week,
                    EmployeeCount: employeeCount,
                    BaseCount: baseCount,
                    FromDate: fromDate,
                    ToDate: toDate
                };
                // Initialize all columns with a default value of 0
                categories.forEach(category => {
                    // const categoryKey = category.replace(/[^a-zA-Z0-9]/g, ''); // Remove special characters

                    const categoryKey = category.replace('.', '');
                    reshapedData[key][categoryKey + '_LT_H'] = 0;
                    reshapedData[key][categoryKey + '_Percentage'] = 0;
                });
            }

            // const category = item.Category.replace(/[^a-zA-Z0-9]/g, ''); // Remove special characters
            const category = item.Category.replace('.', '');
            reshapedData[key][category + '_LT_H'] = item.LT_H;
            reshapedData[key][category + '_Percentage'] = item.Percentage;
        });

        // Convert the reshapedData object into an array
        const reshapedArray = Object.values(reshapedData);
        return reshapedArray;
    }

    function generateDeptMonthColumns(data) {

        const columns = [
            { data: 'REGION', title: 'REGION' },
            { data: 'DEPARTMENT', title: 'DEPARTMENT' },
            { data: 'MONTH', title: 'Month Name' },
            { data: 'EmployeeCount', title: 'EmployeeCount' },
            { data: 'BaseCount', title: 'BaseCount' },
            { data: '项目Project_LT_H', title: '项目Project LT_H' },
            { data: '运维-需求Maintenance-Req_LT_H', title: '运维-需求Maintenance-Req. LT_H' },
            { data: '运维-日常Maintenance-Daily_LT_H', title: '运维-日常Maintenance-Daily LT_H' },
            { data: '行政管理Administration_LT_H', title: '行政管理Administration LT_H' },
            { data: '培训学习 Training/Study_LT_H', title: '培训学习Training/Study LT_H' },
            { data: '休假 Leave_LT_H', title: '休假 Leave LT_H' },

            { data: '空闲 Idle_LT_H', title: '空闲 Idle LT_H' },
        ];

        /* const categories = { };
                 const categories2 = { };
         data.forEach(item => {
             const category = item.Category.replace('.', ''); // Remove periods
                 const originalCategory = item.Category;
                 if (!categories[category]) {
    
                     categories[category] = true;
                 columns.push({data: category + '_LT_H', title: originalCategory + ' (LT_H)' });
             }
         });*/

        // Add SUM (LT_H) column
        /* const sumColumn = {
                     title: 'SUM (LT_H)',
                 render: function (data, type, row) {
                     let sum = 0;
                 Object.keys(categories).forEach(category => {
                     sum += parseInt(row[category + '_LT_H'] || 0);
                 });
                 return sum;
             }
         };*/
        const sumColumn = {
            title: 'SUM (LT_H)',
            render: function (data, type, row) {
                let sum = 0;
                Object.keys(row).forEach(key => {
                    if (key.endsWith('_LT_H')) {
                        sum += parseFloat(row[key] || 0);
                    }
                });
                return sum.toFixed(2);
            }
        };
        columns.push(sumColumn);

        // Add Percentage columns
        /* data.forEach(item => {
    
             const category = item.Category.replace('.', ''); // Remove periods
                 const originalCategory = item.Category;
                 if (!categories2[category]) {
                     categories2[category] = true;
    
                 columns.push({data: category + '_Percentage', title: originalCategory + '%' });
             }
         });*/
        columns.push({ data: '项目Project_Percentage', title: '项目Project %' });
        columns.push({ data: '运维-需求Maintenance-Req_Percentage', title: '运维-需求Maintenance-Req. %' });
        columns.push({ data: '运维-日常Maintenance-Daily_Percentage', title: '运维-日常Maintenance-Daily %' });
        columns.push({ data: '行政管理Administration_Percentage', title: '行政管理Administration %' });
        columns.push({ data: '培训学习 Training/Study_Percentage', title: '休假 Leave %' });
        columns.push({ data: '休假 Leave_Percentage', title: '培训学习 Training/Study %' });
        columns.push({ data: '空闲 Idle_Percentage', title: '空闲 Idle %' });
        /* const sumPercent = {
                     title: 'SUM (%)',
                 render: function (data, type, row) {
                     let sum = 0;
                 Object.keys(categories).forEach(category => {
                     sum += parseInt(row[category + '_Percentage'] || 0);
                 });
                 return sum;
             }
         };*/
        const sumPercent = {
            title: 'SUM (%)',
            render: function (data, type, row) {
                let sum = 0;
                Object.keys(row).forEach(key => {
                    if (key.endsWith('_Percentage')) {
                        sum += parseFloat(row[key] || 0);
                    }
                });
                return sum.toFixed(2);
            }
        };
        columns.push(sumPercent);
        columns.push({ data: 'FromDate', title: 'From Date' });
        columns.push({ data: 'ToDate', title: 'To Date' });

        return columns;
    }

    function reshapeDeptMonthData(data) {

        const categories = [
            '项目Project',
            '运维-需求Maintenance-Req.',
            '运维-日常Maintenance-Daily',
            '行政管理Administration',
            '培训学习 Training/Study',
            '休假 Leave',
            '空闲 Idle'
        ];
        const reshapedData = {};

        data.forEach(item => {
            const region = item.Region;
            const department = item.Department; // Add department
            const mnth = item.month_name;
            const fromDate = item.fromdate.substring(0, 10);
            const toDate = item.todate.substring(0, 10);
            const employeeCount = item.EmployeeCount;
            const baseCount = item.BaseCount;

            const key = region + '_' + department + '_' + mnth; // Generate key combining region, department, and week

            if (!reshapedData[key]) {
                reshapedData[key] = {
                    REGION: region,
                    DEPARTMENT: department, // Add department
                    MONTH: mnth,
                    EmployeeCount: employeeCount,
                    BaseCount: baseCount,
                    FromDate: fromDate,
                    ToDate: toDate
                };
                // Initialize all columns with a default value of 0
                categories.forEach(category => {
                    // const categoryKey = category.replace(/[^a-zA-Z0-9]/g, ''); // Remove special characters

                    const categoryKey = category.replace('.', '');
                    reshapedData[key][categoryKey + '_LT_H'] = 0;
                    reshapedData[key][categoryKey + '_Percentage'] = 0;
                });
            }

            // const category = item.Category.replace(/[^a-zA-Z0-9]/g, ''); // Remove special characters
            const category = item.Category.replace('.', '');
            reshapedData[key][category + '_LT_H'] = item.LT_H;
            reshapedData[key][category + '_Percentage'] = item.Percentage;
        });

        // Convert the reshapedData object into an array
        const reshapedArray = Object.values(reshapedData);
        return reshapedArray;
    }

    function populateDataTable(data, columns, start_date, to_date) {

        if ($.fn.DataTable.isDataTable('#M_dataTable')) {
            // $('#M_dataTable').DataTable().destroy();
            $('#M_dataTable').DataTable().clear().destroy();
        }



        $('#M_dataTable').DataTable({
            data: data,
            columns: columns,
            autoWidth: false,
            scrollX: true,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    title: `Manday Input Excel Report from ${start_date} to ${to_date}`,
                    text: 'Download Excel',
                    className: 'excel-button'

                }
            ]
        });
    }


    function get_week_strt_end() {
        var startWeek = $('#weekPicker').val();
        var endWeek = $('#weekPicker2').val();
        function getDateOfISOWeek(w, y) {
            var simple = new Date(y, 0, 1 + (w - 1) * 7);
            var dow = simple.getDay();
            var ISOweekStart = simple;
            if (dow <= 4) {
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 2);
            } else {
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            }
            return ISOweekStart;
        }


        var startWeekParts = startWeek.split(' / ');
        var endWeekParts = endWeek.split(' / ');

        var startWeekNumber = parseInt(startWeekParts[0], 10);
        var startWeekYear = parseInt(startWeekParts[1], 10);

        var endWeekNumber = parseInt(endWeekParts[0], 10);
        var endWeekYear = parseInt(endWeekParts[1], 10);

        var startDateOfWeek = getDateOfISOWeek(startWeekNumber, startWeekYear);
        var endDateOfWeek = getDateOfISOWeek(endWeekNumber, endWeekYear);
        endDateOfWeek.setDate(endDateOfWeek.getDate() + 6); // Last day of the end week

        var formattedStartDateOfWeek = startDateOfWeek.toISOString().split('T')[0];
        var formattedEndDateOfWeek = endDateOfWeek.toISOString().split('T')[0];
       
         requestData = {
           
            startWeekDate: formattedStartDateOfWeek,
            endWeekDate: formattedEndDateOfWeek,
           
        };
        
    }

    function get_month_strt_end(){
        var startMonth = $('#s_date').val();
        var endMonth = $('#e_date').val();

        function getFirstDateOfMonth(month, year) {
            let firstDate = new Date(year, month, 1);
            firstDate.setDate(firstDate.getDate() + 1);
            return firstDate;
        }


        function getLastDateOfMonth(month, year) {

            let lastDate = new Date(year, month + 1, 0)
            lastDate.setDate(lastDate.getDate() + 1);
            return lastDate;
        }


        var startMonthParts = startMonth.split('-');
        var endMonthParts = endMonth.split('-');

        var startMonthNumber = parseInt(startMonthParts[1], 10) - 1;
        var startYear = parseInt(startMonthParts[0], 10);

        var endMonthNumber = parseInt(endMonthParts[1], 10) - 1;
        var endYear = parseInt(endMonthParts[0], 10);


        var startDateOfMonth = getFirstDateOfMonth(startMonthNumber, startYear);
        var endDateOfMonth = getLastDateOfMonth(endMonthNumber, endYear);


        var formattedStartDateOfMonth = startDateOfMonth.toISOString().split('T')[0];
        var formattedEndDateOfMonth = endDateOfMonth.toISOString().split('T')[0];



         requestData = {
            startMonthDate: formattedStartDateOfMonth,
            endMonthDate: formattedEndDateOfMonth

        };
    }



    $('#search').click(function () {
        
       
        if ($("#region").val() == "") {
            alert('Please Select Region');
            $("#region").focus();
        }

        //else if ($("#department").val() == "") {
        //    alert('Please Select Department');
        //    $("#department").focus();
        //}

        //else if ($("#emp_no").val() == "") {
        //    alert('Please Select Employee');
        //    $("#emp_no").focus();
        //}
        else if ($('#category').val() == '') {
            alert('Please Select Category');
            $("#category").focus();
        }
        else if ($("#s_date").val() == "" && $('#date_type').val() == 'bymonth') {
            alert('Please Select From month');
            $("#s_date").focus();
            return false;
        } else if ($("#e_date").val() == "" && $('#date_type').val() == 'bymonth') {
            alert('Please Select To month');
            $("#e_date").focus();
            return false;
        } else if ($("#weekPicker").val() == "" && $('#date_type').val() == 'byweek') {
            alert('Please Select From week');
            $("#weekPicker").focus();
            return false;
        } else if ($("#weekPicker2").val() == "" && $('#date_type').val() == 'byweek') {
            alert('Please Select To week');
            $("#weekPicker2").focus();
            return false;
        }
        else if ($("#s_date").val() > $("#e_date").val()) {
            alert('Start month greater than To month');
            $("#s_date").focus();
        }
        //else if ($("#weekPicker").val() > $("#weekPicker2").val()) {
        //    console.log($("#weekPicker").val());
        //    console.log($("#weekPicker2").val());
        //    alert('Start week greater than To week');
        //    $("#weekPicker").focus();
        //}
        else {
            var User = {};
            User.Region = $('#region').val();
            User.Category = $('#category').val();
            if ($('#date_type').val() == 'bymonth') {
                get_month_strt_end();
                User.Start_month = requestData.startMonthDate;
                User.To_month = requestData.endMonthDate;
            } else if ($('#date_type').val() == 'byweek') {
                get_week_strt_end();
                User.Start_wk = requestData.startWeekDate;
                User.End_wk = requestData.endWeekDate;
            }

            
            
           
          


            if ($('#chart_type').val() == 'byregion' && $('#date_type').val() == 'byweek') {


                //$.ajax({
                //    type: "GET",
                //    dataType: "json",
                //    //contentType: "application/json",
                //    data: User,
                //    url: apiURL + 'GetChartBYREG_Weekly',
                //    success: function (data) {

                //        jsonData = data;

                //        var weeks = [...new Set(jsonData.map(item => item.week_no))];
                //        var regions = [...new Set(jsonData.map(item => item.Region))];
                //        var categories = [...new Set(jsonData.map(item => item.Category))];
                //        var series = [];




                //        categories.forEach(function (category) {
                //            // Create series data for the current category
                //            var seriesData = [];
                //            weeks.forEach(function (week) {
                //                regions.forEach(function (region) {
                //                    var dataPoint = jsonData.find(item => item.week_no === week && item.Category === category && item.Region === region);
                //                    seriesData.push(dataPoint ? dataPoint.Percentage : 0);
                //                });
                //            });

                //            // Push the series object for the current category
                //            series.push({
                //                name: category,
                //                data: seriesData
                //            });
                //        });
                //        var xCategories = [];
                //        weeks.forEach(week => {
                //            regions.forEach(region => {
                //                xCategories.push(`${week}<br>(${region})`);
                //            });
                //        });


                //        var option = {
                //            'stroke-width': 1,
                //            stroke: '#2f7ed8', // Background color
                //            fill: '#2f7ed8', // Border color
                //            r: 2,
                //            padding: 5,
                //            style: {
                //                color: '#FFFFFF' // Text color
                //            }
                //        };
                //        var categoryColors = {
                //            '项目Project': '#00b050',
                //            '运维-需求Maintenance-Req.': '#00b0f0',
                //            '运维-日常Maintenance-Daily': '#b4c7e7',
                //            '行政管理Administration': '#e2aa00',
                //            '培训学习 Training/Study': '#56247a',
                //            '休假 Leave': '#a0a0a0',
                //            '空闲 Idle': '#ff0101'
                //        };

                //        // Initialize Highcharts chart
                //        Highcharts.chart('container', {
                //            chart: {
                //                type: 'column',
                //                events: {
                //                    load: function () {
                //                        this.renderer.button('Excel Report', this.chartWidth - 100, 40, function () {
                //                            // Add button click functionality here

                //                            const reshapedData = reshapeRegWeekData(data);
                //                            const columns = generateRegWeekColumns(data);
                //                            const start_date = $('#s_date').val();
                //                            const to_date = $('#e_date').val();
                //                            populateDataTable(reshapedData, columns, start_date, to_date);
                //                            $('#excelModal').modal('show');
                //                        }, option, option, option)
                //                            .attr({
                //                                id: 'excelButton'
                //                            })
                //                            .on('mouseover', function () {
                //                                $(this.element).css({
                //                                    'fill': '#2f7ed8',
                //                                    'stroke': '#2f7ed8',
                //                                });
                //                            })
                //                            .on('mouseout', function () {
                //                                $(this.element).css({
                //                                    'fill': '#2f7ed8',
                //                                    'stroke': '#2f7ed8',
                //                                });
                //                            })
                //                            .add();
                //                    }
                //                }
                //            },
                //            title: {
                //                text: 'Department Category Count by Region'
                //            },
                //            //xAxis: {
                //            //    categories: weeks.map(week => week + '<br>(' + regions.find(region => jsonData.some(item => item.week_no === week && item.Region === region)) + ')'),
                //            //    title: {
                //            //        text: 'Department (Region)'
                //            //    }
                //            //},
                //            xAxis: {
                //                categories: xCategories,
                //                title: {
                //                    text: 'Week (Region)'
                //                }
                //            },
                //            yAxis: {
                //                min: 0,
                //                title: {
                //                    text: 'Percentage'
                //                },
                //                stackLabels: {
                //                    enabled: true,
                //                    style: {
                //                        fontWeight: 'bold',
                //                        color: (Highcharts.defaultOptions.title.style && Highcharts.defaultOptions.title.style.color) || 'gray'
                //                    }
                //                }
                //            },
                //            legend: {
                //                reversed: true
                //            },
                //            plotOptions: {
                //                column: {
                //                    stacking: 'normal',
                //                    dataLabels: {
                //                        enabled: true
                //                    }

                //                }
                //            },
                //            series: series.map(function (s) {
                //                return {
                //                    name: s.name,
                //                    data: s.data,
                //                    color: categoryColors[s.name] || null // Assign color from categoryColors, or null if not specified
                //                };
                //            })

                //        });


                //    }
                //});

                $.ajax({
                    type: "GET",
                    dataType: "json",
                    data: User,
                    url: apiURL + 'GetChartBYREG_Weekly',
                    success: function (data) {

                        jsonData = data;

                        var weeks = [...new Set(jsonData.map(item => item.week_no))];
                        var regions = [...new Set(jsonData.map(item => item.Region))];
                        var categoryColors = {
                            '项目Project': '#00b050',
                            '运维-需求Maintenance-Req.': '#00b0f0',
                            '运维-日常Maintenance-Daily': '#b4c7e7',
                            '行政管理Administration': '#e2aa00',
                            '培训学习 Training/Study': '#56247a',
                            '休假 Leave': '#a0a0a0',
                            '空闲 Idle': '#ff0101'
                        };
                        var series = [];

                        // Reverse the order of categoryColors keys
                        var categoryKeys = Object.keys(categoryColors).reverse();
                        categoryKeys.forEach(function (category) {
                            // Create series data for the current category
                            var seriesData = [];
                            weeks.forEach(function (week) {
                                regions.forEach(function (region) {
                                    var dataPoint = jsonData.find(item => item.week_no === week && item.Category === category && item.Region === region);
                                    seriesData.push(dataPoint ? dataPoint.Percentage : 0);
                                });
                            });

                            // Push the series object for the current category
                            series.push({
                                name: category,
                                data: seriesData,
                                color: categoryColors[category] // Assign color from categoryColors
                            });
                        });

                        var xCategories = [];
                        weeks.forEach(week => {
                            regions.forEach(region => {
                                xCategories.push(`${week}<br>(${region})`);
                            });
                        });

                        var option = {
                            'stroke-width': 1,
                            stroke: '#2f7ed8',
                            fill: '#2f7ed8',
                            r: 2,
                            padding: 5,
                            style: {
                                color: '#FFFFFF'
                            }
                        };

                        Highcharts.chart('container', {
                            chart: {
                                type: 'column',
                                events: {
                                    load: function () {
                                        this.renderer.button('Excel Report', this.chartWidth - 100, 40, function () {
                                            // Add button click functionality here

                                            const reshapedData = reshapeRegWeekData(data);
                                            const columns = generateRegWeekColumns(data);
                                            const start_date = $('#s_date').val();
                                            const to_date = $('#e_date').val();
                                            populateDataTable(reshapedData, columns, start_date, to_date);
                                            $('#excelModal').modal('show');
                                        }, option, option, option)
                                            .attr({
                                                id: 'excelButton'
                                            })
                                            .on('mouseover', function () {
                                                $(this.element).css({
                                                    'fill': '#2f7ed8',
                                                    'stroke': '#2f7ed8',
                                                });
                                            })
                                            .on('mouseout', function () {
                                                $(this.element).css({
                                                    'fill': '#2f7ed8',
                                                    'stroke': '#2f7ed8',
                                                });
                                            })
                                            .add();
                                    }
                                }
                            },
                            title: {
                                text: 'Weekly Category Count by Region'
                            },
                            xAxis: {
                                categories: xCategories,
                                title: {
                                    text: 'Week (Region)'
                                }
                            },
                            yAxis: {
                                min: 0,
                                title: {
                                    text: 'Percentage'
                                },
                                stackLabels: {
                                    enabled: true,
                                    style: {
                                        fontWeight: 'bold',
                                        color: (Highcharts.defaultOptions.title.style && Highcharts.defaultOptions.title.style.color) || 'gray'
                                    }
                                }
                            },
                            legend: {
                                reversed: true
                            },
                            plotOptions: {
                                column: {
                                    stacking: 'normal',
                                    dataLabels: {
                                        enabled: true
                                    }
                                }
                            },
                            series: series
                        });
                    }
                });


            }
            else if ($('#chart_type').val() == 'byregion' && $('#date_type').val() == 'bymonth') {

                //$.ajax({
                //    type: "GET",
                //    dataType: "json",
                //    //contentType: "application/json",
                //    data: User,
                //    url: apiURL + 'GetChartBYREG_Monthly',
                //    success: function (data) {

                //        jsonData = data;

                //        var months = [...new Set(jsonData.map(item => item.month_name))];
                //        var regions = [...new Set(jsonData.map(item => item.Region))];
                //        var categories = [...new Set(jsonData.map(item => item.Category))];
                //        var series = [];

                //        // Loop through each category
                //        //categories.forEach(function (category) {

                //        //    var seriesData = weeks.map(function (week) {
                //        //        var dataPoint = jsonData.find(item => item.week_no === week && item.Category === category);
                //        //        return dataPoint ? dataPoint.Percentage : 0;
                //        //    });

                //        //    // Push the series object for the current category
                //        //    series.push({
                //        //        name: category,
                //        //        data: seriesData
                //        //    });
                //        //});
                //        categories.forEach(function (category) {
                //            // Create series data for the current category
                //            var seriesData = [];
                //            months.forEach(function (mnth) {
                //                regions.forEach(function (region) {
                //                    var dataPoint = jsonData.find(item => item.month_name === mnth && item.Category === category && item.Region === region);
                //                    seriesData.push(dataPoint ? dataPoint.Percentage : 0);
                //                });
                //            });

                //            // Push the series object for the current category
                //            series.push({
                //                name: category,
                //                data: seriesData
                //            });
                //        });
                //        var xCategories = [];
                //        months.forEach(mnth => {
                //            regions.forEach(region => {
                //                xCategories.push(`${mnth}<br>(${region})`);
                //            });
                //        });
                //        var option = {
                //            'stroke-width': 1,
                //            stroke: '#2f7ed8', // Background color
                //            fill: '#2f7ed8', // Border color
                //            r: 2,
                //            padding: 5,
                //            style: {
                //                color: '#FFFFFF' // Text color
                //            }
                //        };
                //        var categoryColors = {
                //            '项目Project': '#00b050',
                //            '运维-需求Maintenance-Req.': '#00b0f0',
                //            '运维-日常Maintenance-Daily': '#b4c7e7',
                //            '行政管理Administration': '#e2aa00',
                //            '培训学习 Training/Study': '#56247a',
                //            '休假 Leave': '#a0a0a0',
                //            '空闲 Idle': '#ff0101'
                //        };

                //        // Initialize Highcharts chart
                //        Highcharts.chart('container', {
                //            chart: {
                //                type: 'column',
                //                events: {
                //                    load: function () {
                //                        this.renderer.button('Excel Report', this.chartWidth - 100, 40, function () {
                //                            // Add button click functionality here

                //                            const reshapedData = reshapeRegMonthData(data);
                //                            const columns = generateRegMonthColumns(data);
                //                            const start_date = $('#s_date').val();
                //                            const to_date = $('#e_date').val();
                //                            populateDataTable(reshapedData, columns, start_date, to_date);
                //                            $('#excelModal').modal('show');
                //                        }, option, option, option)
                //                            .attr({
                //                                id: 'excelButton'
                //                            })
                //                            .on('mouseover', function () {
                //                                $(this.element).css({
                //                                    'fill': '#2f7ed8',
                //                                    'stroke': '#2f7ed8',
                //                                });
                //                            })
                //                            .on('mouseout', function () {
                //                                $(this.element).css({
                //                                    'fill': '#2f7ed8',
                //                                    'stroke': '#2f7ed8',
                //                                });
                //                            })
                //                            .add();
                //                    }
                //                }
                //            },
                //            title: {
                //                text: 'Department Category Count by Region'
                //            },
                //            //xAxis: {
                //            //    categories: weeks.map(week => week + '<br>(' + regions.find(region => jsonData.some(item => item.week_no === week && item.Region === region)) + ')'),
                //            //    title: {
                //            //        text: 'Department (Region)'
                //            //    }
                //            //},
                //            xAxis: {
                //                categories: xCategories,
                //                title: {
                //                    text: 'Week (Region)'
                //                }
                //            },
                //            yAxis: {
                //                min: 0,
                //                title: {
                //                    text: 'Percentage'
                //                },
                //                stackLabels: {
                //                    enabled: true,
                //                    style: {
                //                        fontWeight: 'bold',
                //                        color: (Highcharts.defaultOptions.title.style && Highcharts.defaultOptions.title.style.color) || 'gray'
                //                    }
                //                }
                //            },
                //            legend: {
                //                reversed: true
                //            },
                //            plotOptions: {
                //                column: {
                //                    stacking: 'normal',
                //                    dataLabels: {
                //                        enabled: true
                //                    }

                //                }
                //            },
                //            series: series.map(function (s) {
                //                return {
                //                    name: s.name,
                //                    data: s.data,
                //                    color: categoryColors[s.name] || null // Assign color from categoryColors, or null if not specified
                //                };
                //            })

                //        });


                //    }
                //});

                $.ajax({
                    type: "GET",
                    dataType: "json",
                    data: User,
                    url: apiURL + 'GetChartBYREG_Monthly',
                    success: function (data) {

                        jsonData = data;

                        var months = [...new Set(jsonData.map(item => item.month_name))];
                        var regions = [...new Set(jsonData.map(item => item.Region))];
                        var categoryColors = {
                            '项目Project': '#00b050',
                            '运维-需求Maintenance-Req.': '#00b0f0',
                            '运维-日常Maintenance-Daily': '#b4c7e7',
                            '行政管理Administration': '#e2aa00',
                            '培训学习 Training/Study': '#56247a',
                            '休假 Leave': '#a0a0a0',
                            '空闲 Idle': '#ff0101'
                        };
                        var series = [];

                        // Reverse the order of categoryColors keys
                        var categoryKeys = Object.keys(categoryColors).reverse();
                        categoryKeys.forEach(function (category) {
                            // Create series data for the current category
                            var seriesData = [];
                            months.forEach(function (month) {
                                regions.forEach(function (region) {
                                    var dataPoint = jsonData.find(item => item.month_name === month && item.Category === category && item.Region === region);
                                    seriesData.push(dataPoint ? dataPoint.Percentage : 0);
                                });
                            });

                            // Push the series object for the current category
                            series.push({
                                name: category,
                                data: seriesData,
                                color: categoryColors[category] // Assign color from categoryColors
                            });
                        });

                        var xCategories = [];
                        months.forEach(month => {
                            regions.forEach(region => {
                                xCategories.push(`${month}<br>(${region})`);
                            });
                        });

                        var option = {
                            'stroke-width': 1,
                            stroke: '#2f7ed8',
                            fill: '#2f7ed8',
                            r: 2,
                            padding: 5,
                            style: {
                                color: '#FFFFFF'
                            }
                        };

                        Highcharts.chart('container', {
                            chart: {
                                type: 'column',
                                events: {
                                    load: function () {
                                        this.renderer.button('Excel Report', this.chartWidth - 100, 40, function () {
                                            // Add button click functionality here

                                            const reshapedData = reshapeRegMonthData(data);
                                            const columns = generateRegMonthColumns(data);
                                            const start_date = $('#s_date').val();
                                            const to_date = $('#e_date').val();
                                            populateDataTable(reshapedData, columns, start_date, to_date);
                                            $('#excelModal').modal('show');
                                        }, option, option, option)
                                            .attr({
                                                id: 'excelButton'
                                            })
                                            .on('mouseover', function () {
                                                $(this.element).css({
                                                    'fill': '#2f7ed8',
                                                    'stroke': '#2f7ed8',
                                                });
                                            })
                                            .on('mouseout', function () {
                                                $(this.element).css({
                                                    'fill': '#2f7ed8',
                                                    'stroke': '#2f7ed8',
                                                });
                                            })
                                            .add();
                                    }
                                }
                            },
                            title: {
                                text: 'Monthly Category Count by Region'
                            },
                            xAxis: {
                                categories: xCategories,
                                title: {
                                    text: 'Month (Region)'
                                }
                            },
                            yAxis: {
                                min: 0,
                                title: {
                                    text: 'Percentage'
                                },
                                stackLabels: {
                                    enabled: true,
                                    style: {
                                        fontWeight: 'bold',
                                        color: (Highcharts.defaultOptions.title.style && Highcharts.defaultOptions.title.style.color) || 'gray'
                                    }
                                }
                            },
                            legend: {
                                reversed: true
                            },
                            plotOptions: {
                                column: {
                                    stacking: 'normal',
                                    dataLabels: {
                                        enabled: true
                                    }
                                }
                            },
                            series: series
                        });
                    }
                });


            }
            else if ($('#chart_type').val() == 'bydepartment' && $('#date_type').val() == 'byweek') {
                
                var departmentValue = $('#department').val().toString();
                var departmentArray = departmentValue.split(',').map(function (dept) {
                    return "'" + dept.trim() + "'";
                });
                var formattedDepartmentValue = departmentArray.join(',');

                User.Department = formattedDepartmentValue
                

                if (User.Region == 'ALL') {
                    $.ajax({
                        type: "GET",
                        dataType: "json",
                        data: User,
                        url: apiURL + 'GetChartBYREG_Weekly',
                        success: function (data) {

                            jsonData = data;

                            var weeks = [...new Set(jsonData.map(item => item.week_no))];
                            var regions = [...new Set(jsonData.map(item => item.Region))];
                            var categoryColors = {
                                '项目Project': '#00b050',
                                '运维-需求Maintenance-Req.': '#00b0f0',
                                '运维-日常Maintenance-Daily': '#b4c7e7',
                                '行政管理Administration': '#e2aa00',
                                '培训学习 Training/Study': '#56247a',
                                '休假 Leave': '#a0a0a0',
                                '空闲 Idle': '#ff0101'
                            };
                            var series = [];

                            // Reverse the order of categoryColors keys
                            var categoryKeys = Object.keys(categoryColors).reverse();
                            categoryKeys.forEach(function (category) {
                                // Create series data for the current category
                                var seriesData = [];
                                weeks.forEach(function (week) {
                                    regions.forEach(function (region) {
                                        var dataPoint = jsonData.find(item => item.week_no === week && item.Category === category && item.Region === region);
                                        seriesData.push(dataPoint ? dataPoint.Percentage : 0);
                                    });
                                });

                                // Push the series object for the current category
                                series.push({
                                    name: category,
                                    data: seriesData,
                                    color: categoryColors[category] // Assign color from categoryColors
                                });
                            });

                            var xCategories = [];
                            weeks.forEach(week => {
                                regions.forEach(region => {
                                    xCategories.push(`${week}<br>(${region})`);
                                });
                            });

                            var option = {
                                'stroke-width': 1,
                                stroke: '#2f7ed8',
                                fill: '#2f7ed8',
                                r: 2,
                                padding: 5,
                                style: {
                                    color: '#FFFFFF'
                                }
                            };

                            Highcharts.chart('container', {
                                chart: {
                                    type: 'column',
                                    events: {
                                        load: function () {
                                            this.renderer.button('Excel Report', this.chartWidth - 100, 40, function () {
                                                // Add button click functionality here

                                                const reshapedData = reshapeRegWeekData(data);
                                                const columns = generateRegWeekColumns(data);
                                                const start_date = $('#s_date').val();
                                                const to_date = $('#e_date').val();
                                                populateDataTable(reshapedData, columns, start_date, to_date);
                                                $('#excelModal').modal('show');
                                            }, option, option, option)
                                                .attr({
                                                    id: 'excelButton'
                                                })
                                                .on('mouseover', function () {
                                                    $(this.element).css({
                                                        'fill': '#2f7ed8',
                                                        'stroke': '#2f7ed8',
                                                    });
                                                })
                                                .on('mouseout', function () {
                                                    $(this.element).css({
                                                        'fill': '#2f7ed8',
                                                        'stroke': '#2f7ed8',
                                                    });
                                                })
                                                .add();
                                        }
                                    }
                                },
                                title: {
                                    text: 'Weekly Category Count by Region'
                                },
                                xAxis: {
                                    categories: xCategories,
                                    title: {
                                        text: 'Week (Region)'
                                    }
                                },
                                yAxis: {
                                    min: 0,
                                    title: {
                                        text: 'Percentage'
                                    },
                                    stackLabels: {
                                        enabled: true,
                                        style: {
                                            fontWeight: 'bold',
                                            color: (Highcharts.defaultOptions.title.style && Highcharts.defaultOptions.title.style.color) || 'gray'
                                        }
                                    }
                                },
                                legend: {
                                    reversed: true
                                },
                                plotOptions: {
                                    column: {
                                        stacking: 'normal',
                                        dataLabels: {
                                            enabled: true
                                        }
                                    }
                                },
                                series: series
                            });
                        }
                    });
                }
                else {
                    $.ajax({
                        type: "GET",
                        dataType: "json",
                        data: User,
                        url: apiURL + 'GetChartBYDEPT_Weekly',
                        success: function (data) {
                            var jsonData = data;

                            var departments = [...new Set(jsonData.map(item => item.Department))];
                            var weeks = [...new Set(jsonData.map(item => item.week_no))];
                            var regions = [...new Set(jsonData.map(item => item.Region))];
                            var categories = [...new Set(jsonData.map(item => item.Category))];

                            // Order the categories based on the categoryColors keys
                            var categoryColors = {
                                '项目Project': '#00b050',
                                '运维-需求Maintenance-Req.': '#00b0f0',
                                '运维-日常Maintenance-Daily': '#b4c7e7',
                                '行政管理Administration': '#e2aa00',
                                '培训学习 Training/Study': '#56247a',
                                '休假 Leave': '#a0a0a0',
                                '空闲 Idle': '#ff0101'
                            };

                            // Sort and then reverse the categories array
                            categories.sort((a, b) => {
                                const colorKeys = Object.keys(categoryColors);
                                return colorKeys.indexOf(a) - colorKeys.indexOf(b);
                            }).reverse();

                            // Generate unique xCategories for each department, region, and week combination
                            var xCategories = [];
                            var flatCategories = [];

                            jsonData.forEach(item => {
                                var category = `${item.Department} (${item.Region})<br>${item.week_no}`;
                                if (!flatCategories.includes(category)) {
                                    flatCategories.push(category);
                                    xCategories.push({
                                        department: item.Department,
                                        region: item.Region,
                                        week: item.week_no
                                    });
                                }
                            });

                            // Create series data for each category
                            var series = [];
                            categories.forEach(function (category) {
                                var seriesData = xCategories.map(function (xCat) {
                                    var dataPoint = jsonData.find(item =>
                                        item.Department === xCat.department &&
                                        item.Category === category &&
                                        item.Region === xCat.region &&
                                        item.week_no === xCat.week
                                    );
                                    return dataPoint ? dataPoint.Percentage : 0;
                                });

                                series.push({
                                    name: category,
                                    data: seriesData
                                });
                            });

                            var option = {
                                'stroke-width': 1,
                                stroke: '#2f7ed8', // Background color
                                fill: '#2f7ed8', // Border color
                                r: 2,
                                padding: 5,
                                style: {
                                    color: '#FFFFFF' // Text color
                                }
                            };

                            // Initialize Highcharts chart
                            Highcharts.chart('container', {
                                chart: {
                                    type: 'column',
                                    events: {
                                        load: function () {
                                            this.renderer.button('Excel Report', this.chartWidth - 100, 40, function () {
                                                const reshapedData = reshapeDeptWeekData(data);
                                                const columns = generateDeptWeekColumns(data);
                                                const start_date = $('#s_date').val();
                                                const to_date = $('#e_date').val();
                                                populateDataTable(reshapedData, columns, start_date, to_date);
                                                $('#excelModal').modal('show');
                                            }, option, option, option)
                                                .attr({
                                                    id: 'excelButton'
                                                })
                                                .on('mouseover', function () {
                                                    $(this.element).css({
                                                        'fill': '#2f7ed8',
                                                        'stroke': '#2f7ed8',
                                                    });
                                                })
                                                .on('mouseout', function () {
                                                    $(this.element).css({
                                                        'fill': '#2f7ed8',
                                                        'stroke': '#2f7ed8',
                                                    });
                                                })
                                                .add();
                                        }
                                    }
                                },
                                title: {
                                    text: 'Weekly Category Count by Department'
                                },
                                xAxis: {
                                    categories: flatCategories,
                                    title: {
                                        text: 'Department (Region) and Week'
                                    }
                                },
                                yAxis: {
                                    min: 0,
                                    title: {
                                        text: 'Percentage'
                                    },
                                    stackLabels: {
                                        enabled: true,
                                        style: {
                                            fontWeight: 'bold',
                                            color: (Highcharts.defaultOptions.title.style && Highcharts.defaultOptions.title.style.color) || 'gray'
                                        }
                                    }
                                },
                                legend: {
                                    reversed: true
                                },
                                plotOptions: {
                                    column: {
                                        stacking: 'normal',
                                        dataLabels: {
                                            enabled: true
                                        }
                                    }
                                },
                                series: series.map(function (s) {
                                    return {
                                        name: s.name,
                                        data: s.data,
                                        color: categoryColors[s.name] || null
                                    };
                                })
                            });
                        }
                    });
                }


            }
            else if ($('#chart_type').val() == 'bydepartment' && $('#date_type').val() == 'bymonth') {


                var departmentValue = $('#department').val().toString();
                var departmentArray = departmentValue.split(',').map(function (dept) {
                    return "'" + dept.trim() + "'";
                });
                var formattedDepartmentValue = departmentArray.join(',');

                User.Department = formattedDepartmentValue

                if (User.Region == 'ALL') {

                    $.ajax({
                        type: "GET",
                        dataType: "json",
                        data: User,
                        url: apiURL + 'GetChartBYREG_Monthly',
                        success: function (data) {

                            jsonData = data;

                            var months = [...new Set(jsonData.map(item => item.month_name))];
                            var regions = [...new Set(jsonData.map(item => item.Region))];
                            var categoryColors = {
                                '项目Project': '#00b050',
                                '运维-需求Maintenance-Req.': '#00b0f0',
                                '运维-日常Maintenance-Daily': '#b4c7e7',
                                '行政管理Administration': '#e2aa00',
                                '培训学习 Training/Study': '#56247a',
                                '休假 Leave': '#a0a0a0',
                                '空闲 Idle': '#ff0101'
                            };
                            var series = [];

                            // Reverse the order of categoryColors keys
                            var categoryKeys = Object.keys(categoryColors).reverse();
                            categoryKeys.forEach(function (category) {
                                // Create series data for the current category
                                var seriesData = [];
                                months.forEach(function (month) {
                                    regions.forEach(function (region) {
                                        var dataPoint = jsonData.find(item => item.month_name === month && item.Category === category && item.Region === region);
                                        seriesData.push(dataPoint ? dataPoint.Percentage : 0);
                                    });
                                });

                                // Push the series object for the current category
                                series.push({
                                    name: category,
                                    data: seriesData,
                                    color: categoryColors[category] // Assign color from categoryColors
                                });
                            });

                            var xCategories = [];
                            months.forEach(month => {
                                regions.forEach(region => {
                                    xCategories.push(`${month}<br>(${region})`);
                                });
                            });

                            var option = {
                                'stroke-width': 1,
                                stroke: '#2f7ed8',
                                fill: '#2f7ed8',
                                r: 2,
                                padding: 5,
                                style: {
                                    color: '#FFFFFF'
                                }
                            };

                            Highcharts.chart('container', {
                                chart: {
                                    type: 'column',
                                    events: {
                                        load: function () {
                                            this.renderer.button('Excel Report', this.chartWidth - 100, 40, function () {
                                                // Add button click functionality here

                                                const reshapedData = reshapeRegMonthData(data);
                                                const columns = generateRegMonthColumns(data);
                                                const start_date = $('#s_date').val();
                                                const to_date = $('#e_date').val();
                                                populateDataTable(reshapedData, columns, start_date, to_date);
                                                $('#excelModal').modal('show');
                                            }, option, option, option)
                                                .attr({
                                                    id: 'excelButton'
                                                })
                                                .on('mouseover', function () {
                                                    $(this.element).css({
                                                        'fill': '#2f7ed8',
                                                        'stroke': '#2f7ed8',
                                                    });
                                                })
                                                .on('mouseout', function () {
                                                    $(this.element).css({
                                                        'fill': '#2f7ed8',
                                                        'stroke': '#2f7ed8',
                                                    });
                                                })
                                                .add();
                                        }
                                    }
                                },
                                title: {
                                    text: 'Monthly Category Count by Region'
                                },
                                xAxis: {
                                    categories: xCategories,
                                    title: {
                                        text: 'Month (Region)'
                                    }
                                },
                                yAxis: {
                                    min: 0,
                                    title: {
                                        text: 'Percentage'
                                    },
                                    stackLabels: {
                                        enabled: true,
                                        style: {
                                            fontWeight: 'bold',
                                            color: (Highcharts.defaultOptions.title.style && Highcharts.defaultOptions.title.style.color) || 'gray'
                                        }
                                    }
                                },
                                legend: {
                                    reversed: true
                                },
                                plotOptions: {
                                    column: {
                                        stacking: 'normal',
                                        dataLabels: {
                                            enabled: true
                                        }
                                    }
                                },
                                series: series
                            });
                        }
                    });

                } else {


                    $.ajax({
                        type: "GET",
                        dataType: "json",
                        data: User,
                        url: apiURL + 'GetChartBYDEPT_Monthly',
                        success: function (data) {
                            var jsonData = data;

                            var departments = [...new Set(jsonData.map(item => item.Department))];
                            var mnths = [...new Set(jsonData.map(item => item.month_name))];
                            var regions = [...new Set(jsonData.map(item => item.Region))];
                            var categories = [...new Set(jsonData.map(item => item.Category))];

                            // Define the category colors
                            var categoryColors = {
                                '项目Project': '#00b050',
                                '运维-需求Maintenance-Req.': '#00b0f0',
                                '运维-日常Maintenance-Daily': '#b4c7e7',
                                '行政管理Administration': '#e2aa00',
                                '培训学习 Training/Study': '#56247a',
                                '休假 Leave': '#a0a0a0',
                                '空闲 Idle': '#ff0101'
                            };

                            // Sort and reverse the categories array to match the desired order
                            categories.sort((a, b) => {
                                const colorKeys = Object.keys(categoryColors);
                                return colorKeys.indexOf(a) - colorKeys.indexOf(b);
                            }).reverse();

                            // Generate unique xCategories for each department, region, and month combination
                            var xCategories = [];
                            var flatCategories = [];

                            jsonData.forEach(item => {
                                var category = `${item.Department} (${item.Region})<br>${item.month_name}`;
                                if (!flatCategories.includes(category)) {
                                    flatCategories.push(category);
                                    xCategories.push({
                                        department: item.Department,
                                        region: item.Region,
                                        mnth: item.month_name
                                    });
                                }
                            });

                            // Create series data for each category
                            var series = [];
                            categories.forEach(function (category) {
                                var seriesData = xCategories.map(function (xCat) {
                                    var dataPoint = jsonData.find(item =>
                                        item.Department === xCat.department &&
                                        item.Category === category &&
                                        item.Region === xCat.region &&
                                        item.month_name === xCat.mnth
                                    );
                                    return dataPoint ? dataPoint.Percentage : 0;
                                });

                                series.push({
                                    name: category,
                                    data: seriesData
                                });
                            });

                            var option = {
                                'stroke-width': 1,
                                stroke: '#2f7ed8',
                                fill: '#2f7ed8',
                                r: 2,
                                padding: 5,
                                style: {
                                    color: '#FFFFFF'
                                }
                            };

                            // Initialize Highcharts chart
                            Highcharts.chart('container', {
                                chart: {
                                    type: 'column',
                                    events: {
                                        load: function () {
                                            this.renderer.button('Excel Report', this.chartWidth - 100, 40, function () {
                                                const reshapedData = reshapeDeptMonthData(data);
                                                const columns = generateDeptMonthColumns(data);
                                                const start_date = $('#s_date').val();
                                                const to_date = $('#e_date').val();
                                                populateDataTable(reshapedData, columns, start_date, to_date);
                                                $('#excelModal').modal('show');
                                            }, option, option, option)
                                                .attr({
                                                    id: 'excelButton'
                                                })
                                                .on('mouseover', function () {
                                                    $(this.element).css({
                                                        'fill': '#2f7ed8',
                                                        'stroke': '#2f7ed8',
                                                    });
                                                })
                                                .on('mouseout', function () {
                                                    $(this.element).css({
                                                        'fill': '#2f7ed8',
                                                        'stroke': '#2f7ed8',
                                                    });
                                                })
                                                .add();
                                        }
                                    }
                                },
                                title: {
                                    text: 'Monthly Category Count by Department'
                                },
                                xAxis: {
                                    categories: flatCategories,
                                    title: {
                                        text: 'Department (Region) and Month'
                                    }
                                },
                                yAxis: {
                                    min: 0,
                                    title: {
                                        text: 'Percentage'
                                    },
                                    stackLabels: {
                                        enabled: true,
                                        style: {
                                            fontWeight: 'bold',
                                            color: (Highcharts.defaultOptions.title.style && Highcharts.defaultOptions.title.style.color) || 'gray'
                                        }
                                    }
                                },
                                legend: {
                                    reversed: true
                                },
                                plotOptions: {
                                    column: {
                                        stacking: 'normal',
                                        dataLabels: {
                                            enabled: true
                                        }
                                    }
                                },
                                series: series.map(function (s) {
                                    return {
                                        name: s.name,
                                        data: s.data,
                                        color: categoryColors[s.name] || null
                                    };
                                })
                            });
                        }
                    });

                }


               

            }

        }

    });
</script>



